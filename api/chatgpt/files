package chatgpt

import (
	http "github.com/bogdanfinn/fhttp"
	"github.com/gin-gonic/gin"

	"github.com/maxduke/go-chatgpt-api/api"
	"github.com/maxduke/go-chatgpt-api/api/chatgpt"
)

func Files(c *gin.Context) {
	url := c.Request.URL.Path
	url = strings.ReplaceAll(url, ChatGPTApiPrefix, ChatGPTApiUrlPrefix)

	queryParams := c.Request.URL.Query().Encode()
	if queryParams != "" {
		url += "?" + queryParams
	}

	// if not set, will return 404
	c.Status(http.StatusOK)

	var req *http.Request
	req, _ = chatgpt.NewRequest(http.MethodGet, url, nil, "", OAIDID)
	req.Header.Set(AuthorizationHeader, GetAccessToken(c))
	resp, err := Client.Do(req)
	if err != nil {
		c.AbortWithStatusJSON(http.StatusInternalServerError, ReturnMessage(err.Error()))
		return
	}

	defer resp.Body.Close()
	if resp.StatusCode != http.StatusOK {
		if resp.StatusCode == http.StatusUnauthorized {
			logger.Error(fmt.Sprintf(AccountDeactivatedErrorMessage, c.GetString(EmailKey)))
		}

		responseMap := make(map[string]interface{})
		json.NewDecoder(resp.Body).Decode(&responseMap)
		c.AbortWithStatusJSON(resp.StatusCode, responseMap)
		return
	}

	var downloadURL DownloadURL
	err = json.NewDecoder(resp.Body).Decode(&downloadURL)
	if err == nil {
		if !strings.HasPrefix(downloadURL.Result, "http") {
			redirectURL = ChatGPTApiUrlPrefix + downloadURL.Result
			req, _ = chatgpt.NewRequest(http.MethodGet, redirectURL, nil, "", OAIDID)
			req.Header.Set(AuthorizationHeader, GetAccessToken(c))
			redirectResp, err := Client.Do(req)
			if redirectResp.StatusCode == http.StatusTemporaryRedirect { // 307 Temporary Redirect
				location := redirectResp.Header.Get("Location")
				if location != "" {
					downloadURL.Result = location
					modifiedJSON, err := json.Marshal(downloadURL)
					if err == nil {
						resp.Body = io.NopCloser(bytes.NewBuffer(modifiedJSON))
					}					
				}
			}
		}
	}

	io.Copy(c.Writer, resp.Body)
}
